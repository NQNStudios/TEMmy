* TEMmy

	TEMmy is an interactive electron microscope tutorial written using literate programming.
	
** Dependencies
	 
	 Most of the dependencies are included in this repository to keep their versions static.

	 You do need to install some of them separately: 

	 - Emacs (with the s string package installed), for compiling this file into a static website.
	 - Mono for running inklecate.exe

	 Parts of the build process are scripted in Bash, so building on Windows is not supported.

*** Inkjs

		Inkjs is a re-implementation of [[http:www.inklestudios.com/ink/][Ink]], a scripting language for making choice-based games. The important parts of TEMmy are written in Ink because it is a simple language, and anyone should be able to update TEMmy's Ink logic by following this guide: [[http:github.com/inkle/ink/blob/master/Documentation/WritingWithInk.md][Writing With Ink]].

		The Inkjs source code is governed by the MIT License, and its license file is included in the boilerplate directory.

*** Ink

		TEMmy is built using Inklecate, the official Ink compiler. Ink is governed by the MIT License, and its license file is included in the inklecate directory.


** Source code
*** HTML

		Inkjs can run on a static HTML website. The HTML for TEMmy lives in [[file+emacs:index.html][index.html]] (which is a modified version of an Inkjs template file).

*** JavaScript

		TEMmy uses some JavaScript functions to manipulate the DOM (for instance, to display images for the tutorial. These functions are defined in the following source block:

		#+begin_src js :tangle temmy.js
			var gStory = null;

			function beep(times=1) {
					var snd = new Audio("data:audio/wav;base64,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qJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU=");  
					for (var i = 0; i < times; ++i) {
					setTimeout(function() { snd.play(); }, i * 500);
					}
			}

			function showImage(file) {
					var elem = document.createElement("img");
					elem.setAttribute("src", "images/" + file);
					document.getElementById("story").appendChild(elem);
			}


			function timer(time) {
			if (gStory.noTimers || gStory.delayingContinue) return;
					var timeParts = time.split(" ");
					var milli = 0;
					for (var idx = 0; idx < timeParts.length; idx += 2) {
							var amount = parseInt(timeParts[idx]);
							var unit = timeParts[idx+1];
							var milliPerUnit = 0;
							switch (unit[0]) {
							case "h": milliPerUnit = 3600000; break;
							case "m": milliPerUnit = 60000; break;
							case "s": milliPerUnit = 1000; break;
							}
							milli += amount * milliPerUnit;
					}
					gStory.delayingContinue = true;
					console.log(milli);
					setTimeout(function() {
					
					gStory.delayingContinue = false;
					gStory.noTimers = true;
					gStory.gContinueStory();
												beep(3);
					}, milli);
			}

			// This function will be called by main.js
			function setupStory(story) {
					gStory = story;
					gStory.noTimers = false;
					story.BindExternalFunction("showImage", showImage);
					story.BindExternalFunction("timer", timer);
					story.BindExternalFunction("beep", beep);
			}
		#+end_src
		
*** Ink

		The code blocks in this subtree contain *all* of TEMmy's internal logic for guiding a new electron microscope user. You should almost never have to edit anything outside this block.

**** Functions

		 #+begin_src ink :tangle temmy.ink
		 EXTERNAL showImage(file)
		 EXTERNAL timer(time)
		 EXTERNAL beep(times)
		 #+end_src

**** Variables

		 #+begin_src ink :tangle temmy.ink
	 
		 VAR current_density = 0
		 VAR capture_estimate = 0

		 -> first_time_ever
		 
		 == tem1_setup
		 // Set TEM1-specific variables
		 ~ current_density = 250
		 ~ capture_estimate = 7

		 ->->

		 == tem2_setup
		 // Set TEM2-specific variables
		 ~ current_density = 65
		 ~ capture_estimate = 3.5

		 ->->
		 
		 #+end_src

**** Protocol

		 #+begin_src ink :tangle temmy.ink
		 == first_time_ever

		 ~ showImage("temmy.png")
		 Welcome to TEMmy, the Electron Microscope tutor named after Toby Fox's adorable character from Undertale.

		 /* // Uncomment this block to test the timer() function:
		 * Start
		 -


		 Waiting 5 seconds
		 ~ timer("5 s")
		 Waited, now
		 * click here
		 - waiting again (1 minute)
		 ~ timer("1 m")
		 Waited!
		 */
		 // This choice should only need to be made once, when TEMmy is opened on the computer corresponding to one of our two TEMs.
		 
		 First of all, which electron microscope are you using?

		 * TEM1
		 -> tem1_setup ->
		 * TEM2
		 -> tem2_setup ->
		 - Great.

		 -> first_time_today

		 == first_time_today

		 You need to warm up the filament in your scope. Make sure TEM Core is open.

		 Check HT Voltage.

		 * HT Voltage is off (red) or less than 80.
		   Someone is in the middle of increasing the HT Voltage, probably because they installed a new filament.
		   -> increase_ht_voltage ->
		 * HT Voltage is on (green) and at 80.
		 
		 - -> turn_on_filament ->
		 
		 
		 - (new_capture) If Serial EM is open from a previous capture, close it. Do not save anything.
		 Turn off the filament {tem2_setup: and BEAM BLANK}.

		 * Ok.
		 - -> rod_out ->
		 Flip the Pump switch to AIR.
		 Watch V18 and V16 in the TEM Center window.

		 * V18 and V16 have turned green, then back to black (closed).
		 - Remove the rod all the way and place it in its holder.

		 Remove the grid from the rod and place it back in the container where it came from. Insert a new grid. Mark where it came from on a sticky note.

		 -> rod_in ->
	 
		 Flip the pump switch to PUMP. The yellow light should be on!
		 
		 * Yellow pump light is on, specimen chamber in TEM Center is GREEN.
		 - You can now twist and insert the rod completely.

		 * HT is at 80, and turned on.
		 - * Penning Gauge is on and below 30.
		 - Turn on the filament.
		 Open SerialEM.
		 Make sure the screen is raised.
		 Hit the low mag button. SerialEM should go to 150X.
		 Turn the aperture dial to the red dot.
		 * These are all done
		 - Wait until the filament is fully on (the button should be bright green and stop blinking).
		 Then lower the screen. (This is the {tem1_setup: F1|Screen Up} button on the right-hand physical control panel.)
		 Examine the section for damage or large dirt.
		 * There is damage/large dirt/holes in the formvar near the sample
		 -> kevin
		 * It looks good
		 - Locate the center of the tissue (move using the scroll ball on the left-hand control panel if necessary).

		 -> low_mag_cook ->
		 -> find_center_150x ->

		 Open Navigator. Hit add points, and place a point at the center point.
		 Stop adding points. Go to XY (or manually move the sample until the center point is centered on the SerialEM capture.
		 
		 * Done
		 - Raise the screen. 
		 Turn the aperture to the {tem1_setup: first|second} white dot (aperture 1, largest white dot on dial).
		 Hit the mag 1 button.

		 Go to 2000X in SerialEM (TODO or is it TEM Center for this?).
		 
		 Recenter the aperture using the dials on the aperture (the other dials on the piece where you just changed to the white dot).
		 
		 Recenter the beam using the {tem1_setup: green dials|XY dials} on the left and right control panels.
		 
		 Delete the point (if you have one) and hit record.

		 -> find_center_2000x ->
		 Make sure the Navigator is open.

		 Navigator (in the menu bar) > Montage and Grids > Add Circle polygon > Enter desired radius (125 for RC3; TODO add a choice to manage this with other samples/core scans).
		 
		 Create a new left-zero-padded 4-digit folder for the section number (off the sticky note), open that folder and save sec#.idoc (no zero-padding).

		 Go to 5000X with spot size 2.

		 Recenter the beam.

		 Put the mirror down and brighten/darken the beam so the current density on TEM Center is about {current_density}.

		 * Done
		 - (focus) Hit the OL wobble button. Check if the dot is moving in a very tiny circle. If not, hit bright tilt and use {tem1_setup: yellow dials|XY dials} to get it back in calibration.

		 Run auto focus. WATCH all of the pictures to make sure none are staticky.

		 * Some images were staticky
		 -> focus
		 * Autofocus proceeded normally
		 - Hit record to check if focused. (You are looking to make sure you can see 2 distinct lines for the fine cell membranes.)
		 Make sure you are at 5000X and spot size 2.
		 Run Calibration > Image shift.
		 
		 * It says "THIS IS BAD" or "THIS IS TERRIBLE"
		 -> focus
		 * It says "THIS IS GOOD"
		 - Click "OK". If a message pops up, select NO.

		 Use the scrollball to find an empty part of formvar. In the Navigator, click "Add Stage Position".

		 * Done
		 - Check again for current density close enough to {current_density}. Move the mirror back out of the beam.

		 Navigator > Acquire at Items

		 Is this a recapture?

		 * Yes
		 Run script Calibrate and Recapture
		 * No
		 Run script High Mag Cook

		 - Is this your last capture of the day (in other words, will you still be here in {capture_estimate} hours?)
		 * Last capture
		 Make sure to leave "turn off filament at end of capture" checked.
		 * Not the last capture
		 Make sure "turn off filament at end of capture" is NOT checked.

		 - Click OK.

		 The status bar should say "capturing X of 900".
		 
		 Fill out the notes file with anything strange that happened during the process. Save it in the folder you created for this section.

		 Put the lid on.

		 TODO step 39 says Image Shift will run again -- but is that true?

		 Step 40: copy the 150X, 2000X screenshots, and the capture data, into a folder labeled with the section number. Upload to Dropbox.

		 * Run another capture
		 -> new_capture

		#+end_src

**** Subroutines

		 #+begin_src ink :tangle temmy.ink
		 
		 == find_center_2000x

		 Use the screenshot to find your high mag center point. For this part, you may need to {tem1_setup: move the sample with the scroll ball and keep hitting "record" to find the spot|use the "Search" function of SerialEM to move the sample and find the center.}

		 Save your new screenshot to the desktop.

		 *Done
		 ->->

		 == find_center_150x

		 Spread the beam and hit RECORD.
		 * Done
		 - Find the center point at 150x, mark it, and save a screenshot to the desktop.
		 
		 TODO this is a little complicated too, and could use its own interactive tutorial.

		 * Done
		 ->->

		 == low_mag_cook

		 Change spot size to 1.
		 Center the beam and condense it to the inner brackets. Make sure you are at 150X.
		 Start Macro 1 (Burn Wobble).

		 * Started it
		 - Now you have to wait 7 minutes--but keep an eye on the process for any problems. I'll time that for you.
		 ~ timer("7 minutes")
		 Now hit stop.

		 * Done
		 ->->

		 == rod_in

		 Insert the specimen rod into safety position. THIS DOES NOT INVOLVE TWISTING I THINK.

		 TODO: More specific instructions/pictures.
		 * Done
		 ->->

		 == rod_out

		 Pull the specimen rod into safety position.

		 (Pull, twist, pull again. Click.)

		 THIS PART IS VERY DELICATE AND CONFUSING. TODO: more specific instructions/pictures.

		 * Done
		 ->->

		 == increase_ht_voltage
		 // TODO notes for this are handwritten
		 // ->->
		 -> kevin

		 == turn_on_filament
		 {tem2_setup: Use the physical control panel on the left to turn on BEAM BLANK. The button should light up.} 

		 Turn the filament on in TEM Core. The button should blink green for a while before becoming solid.
		 
		 Then it could take around 30 minutes to be warmed up.

		 * Time it for me
		 ~ timer("30 m")
		 * Skip that
		 
		 - Ok, should be good to go!

		 ->->

		 == kevin
		 Talk to Kevin.

		 #+end_src

** Build

	 To build TEMmy, simply execute the following function. It will create a directory called temmy which you can upload wherever you want to host TEMmy.

	 #+begin_src emacs-lisp
	 (defun temmy-build () (interactive)
	 (find-file "temmy.org")
	 ;; Make sure there is no existing TEMmy build
		 (shell-command "if [ -d temmy ]; then rm -rf temmy; fi")
		 ;; Generate the Ink file
		 (org-babel-tangle)
		 ;; Compile the ink file
		 (shell-command "mono inklecate/inklecate.exe temmy.ink")

		 ;; Make the static site
		 (shell-command "cp -r boilerplate temmy")
		 (let ((storyjs
						(concat "var storyContent = "
										(with-temp-buffer (insert-file-contents "temmy.ink.json") (buffer-string))
										";")))
			 (save-excursion (find-file "temmy/story.js")
			 (erase-buffer)(insert storyjs)
											 (save-buffer)))
		 (copy-file "index.html" "temmy/")
		 (copy-directory "images" "temmy/")
		 (rename-file "temmy.js" "temmy/")

		 ;; Clean up
		 (shell-command "rm temmy.ink")
		 (shell-command "rm temmy.ink.json")
		 ;; Share with Windows partition
 		 (shell-command "sudo cp -r temmy /mnt/arch-share/")
		 (find-file "temmy.org"))

		 (bind-key* "C-t" 'temmy-build)
	 #+end_src

	 #+RESULTS:
	 : 0


	 
	 
	 
	 
	 

